<p-confirmDialog></p-confirmDialog>

<div class="form-container">

  <ng-container *ngIf="!showSubgroup && subGroups.length === 0; else subgroupTemplate">
    <div class="empty-subgroup-template">
      <img src="./assets/images/sub-group-draw.svg" alt="Icon" class="error-icon" />
      <p *ngIf="!isMarketFormValid">
        {{ "PAGE.PLACEHOLDERS.ADD_SUBGROUP_INFO_INVALID" | translate }}
      </p>
      <p *ngIf="isMarketFormValid">
        {{ "PAGE.PLACEHOLDERS.ADD_SUBGROUP_INFO_VALID" | translate }}
      </p>

      <button
        type="button"
        pButton
        icon="pi pi-plus"
        label="{{ 'PAGE.BUTTONS.ADD_SUBGROUP'|translate }}"
        [outlined]="true"
        (click)="showSubgroupFunc()"
        [disabled]="!isMarketFormValid"
      ></button>
    </div>
  </ng-container>
  
  <ng-template #subgroupTemplate>
  <form [formGroup]="form">


    <p-table [value]="rows.controls" formArrayName="rows" class="p-mb-3">

      <ng-template pTemplate="header">
        <tr>
          <th>Code</th>
          <th>Name</th>
        </tr>
      </ng-template>


      <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
        <tr [formGroupName]="rowIndex">

          <td>
            <p-inputGroup class="input-wrapper">
              <input type="text" placeholder="" pInputText formControlName="marketCode" maxlength="2"
                class="market-input" readonly />
              <p-divider layout="vertical"></p-divider>

              <input type="text" placeholder="Code" pInputText formControlName="subGroupCode" maxlength="1"
                class="subgroup-input" (blur)="row.get('subGroupCode')?.markAsTouched()" />
            </p-inputGroup>
          </td>

          <td>
            <div class="form-inline">
              <input type="text" placeholder="Subgroup Name" pInputText formControlName="subGroupName"
                class="name-input" (blur)="row.get('subGroupName')?.markAsTouched()" />

              <i style="cursor: pointer;" class="fa fa-trash-can delete-icon p-ml-2" (click)="deleteRow(rowIndex)"></i>
            </div>
          </td>
        </tr>

        <tr>
          <td colspan="2">
            <small class="p-error"
              *ngIf="row.get('subGroupCode')?.hasError('pattern') && row.get('subGroupCode')?.touched">
              <span class="error-icon">❗</span>Invalid code format. Only a single alphanumeric character is allowed.
            </small>
            <small class="p-error"
              *ngIf="row.get('subGroupCode')?.hasError('required') && row.get('subGroupCode')?.touched">
              <span class="error-icon">❗</span>Subgroup Code is required.
            </small>
            <small class="p-error"
              *ngIf="row.get('subGroupName')?.hasError('required') && row.get('subGroupName')?.touched">
              <span class="error-icon">❗</span>Subgroup Name is required.
            </small>
            <!-- Check for the 'duplicateSubgroupCode' error at the FormGroup (row) level -->
            <small class="p-error"
              *ngIf="row.hasError('duplicateSubgroupCode') && row.get('subGroupCode')?.touched">
              <span class="error-icon">❗</span>Subgroup Code already exists for this market.
            </small>

            <!-- Check for the 'duplicateSubgroupName' error at the FormGroup (row) level -->
            <small class="p-error"
              *ngIf="row.hasError('duplicateSubgroupName') && row.get('subGroupName')?.touched">
              <span class="error-icon">❗</span>Subgroup Name already exists for this market.
            </small>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <button type="button" pButton icon="pi pi-plus" label="{{ 'PAGE.BUTTONS.ADD_SUBGROUP'|translate }}" [outlined]="true" (click)="addRow()"
      [disabled]="!canAddSubgroup() || !isMarketFormValid"></button>

    </form>
  </ng-template>
</div>